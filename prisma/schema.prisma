// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model Customer {
  id String @id @default(uuid())
  code String @unique
  record String? @unique
  lastName String
  firstName String
  email String?
  phone String?
  whatsAppNumber String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  addressData AddressData?
  user User?
  bookings Booking[]
  consultations Consultation[]
  caseHistory CaseHistory? 
}

model AddressData {
  id String @id @default(uuid())
  street String?
  number String?
  city String?
  postalCode String?
  state String?
  country String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  customerId String @unique
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model User{
  id String @id @default(uuid())
  username String @unique
  password String
  role String @default("USER") // USER, ADMIN, PROVIDER, PATIENT
  isActive Boolean @default(false)
  activationCode String?
  recoveryCode String?
  recoveryCodeExpires DateTime?
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  customerId String? @unique
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  providerId String? @unique
  provider Provider? @relation(fields: [providerId], references:[id], onDelete: Cascade)
}


model Provider {
  id String @id @default(uuid())
  code String @unique // Código legible como PROV-001, PROV-002, etc.
  inService Boolean @default(true)
  dni String @unique
  firstName String        
  lastName String      
  email String?           
  phone String?           
  whatsAppNumber String? 
  record String? @unique
  specialties Specialty[] 
  user User? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  prestations Prestation[]
  consultations Consultation[]
}


model Specialty{
  id String @id @default(uuid())
  code String @unique // Código legible como SPEC-001, SPEC-002, etc.
  name String @unique
  providers Provider[]
  prestations Prestation[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt 
  deletedAt DateTime?
}



enum BiologicalSex {
  MASCULINE
  FEMININE
  NULL_OR_UNSPECIFIED
}



model CaseHistory {
  id String @id @default(uuid())
  number String? @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  caseHistoryPosts CaseHistoryPost[]
  customerId String @unique
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}


model CaseHistoryPost{
  id String @id @default(uuid())
  date DateTime
  content String? @db.Text
  responsibleFirstName String   
  responsibleLastName String     
  responsibleRecord String?      
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  caseHistoryId String
  caseHistory CaseHistory @relation(fields: [caseHistoryId], references: [id], onDelete: Cascade)
}

model Prestation {
  id String @id @default(uuid())
  inService Boolean @default(true)
  code String @unique
  label String @unique
  description String?
  providerId String
  specialtyId String
  provider Provider @relation(fields: [providerId], references: [id], onDelete: SetNull)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  consultations Consultation[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}

enum AppointmentType {
  REGULAR
  ADDITIONAL
  URGENT
}

enum AppointmentPriority {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum AppointmentStatus {
  AVAILABLE
  RESERVED
  NOT_AVAILABLE
  SUSPENDED
  FINISHED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  ABSENT
  SUSPENDED
}

enum ConsultationStatus {
  IN_PROGRESS
  IN_CONSULTATION
  CANCELLED
  COMPLETED
}

model Appointment {
  id String @id @default(uuid())
  type AppointmentType @default(REGULAR)
  startDateTime DateTime @default(now())
  endDateTime DateTime
  prestationId String
  consultationId String? @unique
  status AppointmentStatus @default(AVAILABLE)
  bookings Booking[]
  prestation Prestation @relation(fields: [prestationId], references: [id], onDelete: Cascade)
  consultation Consultation?
}

model Booking {
  id String @id @default(uuid())
  isCurrent Boolean @default(false)
  customerId String
  appointmentId String
  status BookingStatus @default(PENDING)
  statusLastModified DateTime? @default(now()) 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)  
}

model Consultation {
  id String @id @default(uuid())
  code String @default("")
  customerId String
  providerId String
  prestationId String
  appointmentId String? @unique
  clinicHistoryPostId String? @unique
  status ConsultationStatus @default(IN_PROGRESS)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)  
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  prestation Prestation @relation(fields: [prestationId], references: [id], onDelete: Cascade)
}




model Patient {
  id String @id @default(uuid())
  dni String @unique
  birthDate DateTime?
  emergencyContactPhone String?
  emergencyContactName String?
  emergencyContactRelationship String?
  gender Gender @default(OTHER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  customerId String @unique
  hasClinicHistory Boolean @default(false)
  patientMedicalData PatientMedicalData?
}



model PatientMedicalData {
  id String @id @default(uuid())
  bloodType String?
  biologicalSex BiologicalSex? @default(NULL_OR_UNSPECIFIED)
  genderIdentity String? @default("")
  allergies String?
  medicalHistory String?
  currentMedication String?
  familyMedicalHistory String?
  personalMedicalHistory String?
  surgicalHistory String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  patientId String @unique
  patient Patient @relation(fields: [patientId], references: [id])
}



model EntityCounter {
  entity      String   @id  // Clave primaria: 'specialty', 'patient', etc.
  prefix      String        // 'SPEC', 'PAT', 'TURN', 'DOC'
  current     Int      @default(0)      // Último número asignado
  format      String   @default("{prefix}_{seq:4}") // Template opcional
  isActive    Boolean  @default(true)   // Para desactivar temporalmente
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
}